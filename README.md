# 群文件失效检查

一个为 [AstrBot](https://astrbot.app) 设计的、功能强大的**两阶段**文件检查插件。它通过模拟普通用户访问**群文件系统**的方式，精准检查文件是否有效，并能立即提供内容预览，在一段时间后对有效文件进行二次复核，以确保文件的可用性。

## ✨ 功能

* **两阶段检查**: 采用“即时预览 + 延时复核”的智能模式，兼顾了用户的快速反馈需求与文件时效性的长期监控。
* **延时失效复核**: 对初步检查完全有效的文件，在用户设定的延时后，进行第二次检查，专门捕获一段时间后失效的文件。
* **静默成功，失败提醒**: 延时复核成功后会**保持沉默**，避免打扰；只在文件确认已失效时，才会发送通知。
* **合并转发**: 当文本预览或回复消息过长时，自动将内容转为合并转发形式发送，避免刷屏，优化群聊体验。
* **文本识别**: 集成 `chardet` 库，能自动识别并正确处理包括 `UTF-8`, `GBK`, `Big5` (繁體中文) 在内的多种文本编码格式。
* **完全可配置**: 从白名单到两阶段的延时，再到预览长度和转发阈值，插件的核心参数均可在后台自定义。
* **压缩文件处理**: 对于**已失效的 `.txt` 文件**，如果机器人仍能获取其内容，插件会自动将其加密压缩为 `.zip` 格式并重新发送。这个新文件将接替原文件，进入延时复核队列。同时，插件也具备解压压缩包内的 `.txt` 文件并进行预览的能力。
* **重复文件检测**: 具有重复文件检测功能，能自动识别已上传过的文件，并提供文件的历史检查记录，避免重复上传。

---

## 🚀 安装

1. **进入容器安装依赖**：如果你的 AstrBot 运行在 Docker 容器中，请先进入容器内部。
   
   ```bash
   docker ps  # 找到你的 AstrBot 容器ID
   docker exec -it <容器ID> bash  # 或者 sh
   ```
   
   然后在容器内安装 `zip` 依赖库：
   
   ```bash
   # 对于 Debian/Ubuntu 系统
   apt-get update && apt-get install zip p7zip-full
   # 对于 Alpine Linux 系统
   apk add zip p7zip
   ```
2. 下载本仓库。
3. 将整个 `astrbot_plugin_file_checker` 文件夹放入 `astrbot` 的 `plugins` 目录中。
4. 重启 AstrBot。

---

## ⚙️ 配置

本插件支持通过网页后台进行配置。首次加载后，请在 AstrBot 后台 -> 插件 页面找到本插件进行设置。

| 配置项 (`参数名`)                        | 类型       | 默认值 | 说明                                                         |
| ---------------------------------------- | ---------- | ------ | ------------------------------------------------------------ |
| **群聊白名单** (`group_whitelist`)       | list       | `[]`   | 一个列表，填入希望本插件生效的群号。如果此列表为空，插件将在所有群聊中生效。 |
| **成功时通知** (`notify_on_success`)     | bool     | `false`| 开启后，文件检查有效时也会发送一条回复通知。关闭则只在文件失效时通知。 |
| **预检延时 (秒)** (`pre_check_delay_seconds`) | int       | `5`    | 收到文件后，等待多少秒再开始进行阶段一的即时检查。建议设为3-10秒，以确保文件有足够时间同步到群文件系统。 |
| **复核间隔时间 (秒)** (`check_delay_seconds`) | int       | `3600` | 预检通过后，再等待多少秒进行时效性复核。                             |
| **文本预览长度 (字符)** (`preview_length`) | int       | `100`  | 设置在回复中显示的文本内容预览的最大字符数。                         |
| **长消息合并转发阈值 (字符)** (`forward_threshold`) | int       | `500`  | 当插件的单条回复（主要是带预览的）超过此字数时，将自动转为合并转发。设置为 `0` 则禁用此功能。 |
| **启用重复文件检测** (`enable_duplicate_check`) | bool     | `false` | 开启后，当有新文件上传时，插件会检查群内是否已存在相同文件，并提供历史记录。 |
| **启用ZIP文件预览** (`enable_zip_preview`) | bool     | `true` | 开启后，插件会尝试解压收到的ZIP压缩包，并对其中的TXT文件进行内容预览。 |
| **ZIP文件默认解压密码** (`default_zip_password`) | string     | `""`   | 当直接解压ZIP失败时，会尝试使用此密码进行解压。留空表示不使用密码重试。 |
| **为失效TXT重新打包发送** (`enable_repack_on_failure`) | bool     | `false`| 开启后，当TXT文件初步检查失效但机器人仍能下载时，会自动将其压缩为ZIP文件尝试发送。 |
| **重新打包ZIP的加密密码** (`repack_zip_password`) | string     | `""`   | 为失效TXT重新打包成ZIP文件时使用的加密密码。留空表示不加密。       |

---

## 💡 使用

本插件采用两阶段工作模式：

#### 阶段一：即时预览与诊断

当白名单内的群聊有成员发送文件时，插件会在等待“预检延时”后，立即进行一次检查。

* **如果文件已存在**: 插件将直接回复已有的历史记录，并结束流程。
* **如果文件在群文件中有效**:
  * 机器人会**引用回复**一条成功通知。
  * 如果文件是文本，通知中还会附带**内容预览**。
  * 同时，此文件会被加入**延时复核队列**。
* **如果文件在群文件中失效**:
  * 机器人会**引用回复**一条**特殊警告**，例如：“⚠️ 您发送的文件已失效”。
  * 如果失效文件是 `.txt` 格式，且配置允许，机器人会将其重新打包成加密 ZIP 并发送。这个新文件将接替原文件，进入延时复核队列。

#### 阶段二：延时复核

* 只有在**第一阶段完全成功**的文件，或者**被重新打包的新文件**，才会进入此阶段。
* 等待“复核延时”结束后，插件会再次通过**群文件系统API**检查该文件。
* 如果此时文件**依然有效**，机器人会**保持沉默**，不发送任何消息。
* 如果此时文件**已经失效**，机器人会**再次引用回复**原始消息，并发送“经xx秒后复核，已失效”的通知。

---

## 📝 版本记录

* **v1.4**
  * 新增 **重复文件检测** 功能，可识别已上传过的文件，避免重复。
  * 新增 `enable_duplicate_check` 配置项。
* **v1.3**
  * 新增 **压缩文件处理** 功能。对于已失效的 `.txt` 文件，插件可将其加密压缩成 `.zip` 并重新发送，同时支持解压压缩包进行预览。
  * 新增 `enable_repack_on_failure`, `repack_zip_password`, `enable_zip_preview`, `default_zip_password` 配置项。
* **v1.2**
  * 新增 **长消息自动合并转发** 功能及对应的 `forward_threshold` 配置项，避免长文本预览刷屏。
  * 优化 **文件识别逻辑**，完全依赖 `file_id` 进行追踪，解决了在极端情况下可能出现的识别混淆问题。
* **v1.1**
  * 新增 **即时内容预览** 功能，可在回复中显示文本文件开头内容。
  * 新增 **阶段一预检延时** 和 **文本预览长度** 的自定义配置项。
  * 优化 阶段一检查逻辑。
* **v1.0**
  * 插件首次发布。
  * 实现两阶段检查（即时检查 + 延时复核）核心功能。
  * 支持群聊白名单、成功通知开关、复核延时等基础配置。

---

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)
* 如果您在使用中遇到问题，欢迎在本仓库提交 [Issue](https://github.com/Foolllll-J/astrbot_plugin_file_checker/issues)。

