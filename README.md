# 群文件失效检查

一个为 [AstrBot](https://astrbot.app) 设计的**两阶段**文件检查插件。它能**立即**为QQ群聊中的文件提供有效性预览，并在**一段时间后**再次复核文件是否已失效，确保链接的长期可用性。

## ✨ 功能

* **两阶段检查**: 采用“即时预览 + 延时复核”的模式，兼顾了用户的快速反馈需求与文件时效性的长期监控。
* **即时预览与反馈**: 收到文件后会立刻进行初次有效性检查。对于**文本文件**，会自动识别编码并回复内容预览；对于其他二进制文件，会回复初步的有效性状态。
* **延时失效复核**: 在用户设定的延时（例如30秒）后，对文件进行第二次检查，专门用于捕获上传后几分钟后失效的文件。
* **静默成功，失败提醒**: 延时复核成功后会**保持沉默**，避免打扰；只在文件确认已失效时，才会发送通知。
* **群聊白名单**: 可通过后台配置，仅在指定的群聊中启用此功能，实现精准控制。
* **并发控制**: 内置处理队列，能有效应对短时间内接收大量文件（刷屏）的场景，防止因并发下载过多而导致失败。
* **自动清理**: 检查过程中下载的所有临时文件都会被自动删除，不占用硬盘空间。

## 🚀 安装

1. 在您的 AstrBot 运行环境中，安装 `chardet` 依赖库：
   ```bash
   pip install chardet
   ```
2. 下载本仓库。
3. 将整个 `astrbot_plugin_file_checker` 文件夹放入 `astrbot` 的 `plugins` 目录中。
4. 重启 AstrBot。

## ⚙️ 配置

本插件支持通过网页后台进行配置。首次加载后，请在 AstrBot 后台 -\> 插件 页面找到本插件进行设置。

* **群聊白名单 (`group_whitelist`)**: 一个列表，填入希望本插件生效的群号。如果此列表为空，插件将在所有群聊中生效。
* **成功时通知 (`notify_on_success`)**: 一个开关（布尔值）。开启后，阶段一的初步检查成功时会发送通知（文本文件带预览）。关闭则在初步检查成功时也保持沉默。
* **复核延时 (秒) (`check_delay_seconds`)**: 一个整数。设置阶段二复核任务的等待时间，单位为秒。

## 💡 使用

本插件采用两阶段工作模式：

#### **阶段一：即时预览**

当白名单内的群聊有成员发送文件时，插件会**立即**进行一次初步检查。

* 如果文件初步有效，并且“成功时通知”开关已开启：
  * 若文件为**文本**，机器人会**引用回复**并附带内容预览。
  * 若文件为**非文本**（ZIP、图片等），机器人会**引用回复**一条“初步检查有效”的通知。
* 如果文件初步检查就已失效，机器人会直接**引用回复**一条“已失效”的通知。

#### **阶段二：延时复核**

* **如果**第一阶段检查成功，插件会自动在后台启动一个独立的延时复核任务。
* 等待您设定的时间（例如30秒）后，插件会再次下载并检查该文件。
* 如果此时文件**依然有效**，机器人会**保持沉默**，不发送任何消息。
* 如果此时文件**已经失效**，机器人会**再次引用回复**原始消息，并发送“经xx秒后复核，已失效”的通知。

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)
* 如果您在使用中遇到问题，欢迎在本仓库提交 [Issue](https://github.com/Foolllll-J/astrbot_plugin_file_checker/issues)。
