# 群文件失效检查

一个为 [AstrBot](https://astrbot.app) 设计的、功能强大的**两阶段**文件检查插件。它通过模拟普通用户访问**群文件系统**的方式，精准检查文件是否有效，并能立即提供内容预览，在一段时间后对有效文件进行二次复核，以确保文件的可用性。

## ✨ 功能

* **两阶段检查**: 采用“即时预览 + 延时复核”的智能模式，兼顾了用户的快速反馈需求与文件时效性的长期监控。
* **延时失效复核**: 对初步检查完全有效的文件，在用户设定的延时后，进行第二次检查，专门捕获一段时间后失效的文件。
* **静默成功，失败提醒**: 延时复核成功后会**保持沉默**，避免打扰；只在文件确认已失效时，才会发送通知。
* **智能文本识别**: 集成 `chardet` 库，能自动识别并正确处理包括 `UTF-8`, `GBK`, `Big5` (繁體中文) 在内的多种文本编码格式。
* **完全可配置**: 从白名单到两阶段的延时，再到预览长度，插件的核心参数均可在后台自定义。
* **并发控制与自动清理**: 内置并发队列和临时文件自动清理机制，确保插件在高压下稳定运行且不占用服务器资源。

## 🚀 安装

1. 在您的 AstrBot 运行环境中，安装 `chardet` 依赖库：
   ```bash
   pip install chardet
   ```
2. 下载本仓库。
3. 将整个 `astrbot_plugin_file_checker` 文件夹放入 `astrbot` 的 `plugins` 目录中。
4. 重启 AstrBot。

## ⚙️ 配置

本插件支持通过网页后台进行配置。首次加载后，请在 AstrBot 后台 -> 插件 页面找到本插件进行设置。

* **群聊白名单 (`group_whitelist`)**: 一个列表，填入希望本插件生效的群号。如果此列表为空，插件将在所有群聊中生效。
* **成功时通知 (`notify_on_success`)**: 一个开关（布尔值）。开启后，阶段一的初步检查成功时会发送通知。关闭则在初步检查成功时也保持沉默。
* **阶段一预检延时 (秒) (`pre_check_delay_seconds`)**: 整数。收到文件后，等待多少秒再开始进行阶段一的即时检查。建议设为3-10秒，以确保文件有足够时间同步到群文件系统。
* **阶段二复核延时 (秒) (`check_delay_seconds`)**: 整数。阶段一检查成功后，再等待多少秒进行时效性复核。
* **文本预览长度 (字符) (`preview_length`)**: 整数。设置在回复中显示的文本内容预览的最大字符数。

## 💡 使用

本插件采用两阶段工作模式：

#### 阶段一：即时预览与诊断

当白名单内的群聊有成员发送文件时，插件会在等待“预检延时”后，立即进行一次检查。

* 如果文件在**群文件**中检查**有效**：
  * 机器人会**引用回复**一条成功通知。
  * 如果文件是文本，通知中还会附带**内容预览**。
  * 同时，此文件会被加入**延时复核队列**。
* 如果文件在**群文件**中检查**失败**：
  * 机器人会**引用回复**一条**特殊警告**，例如：“⚠️ 您发送的文件已失效”。
  * 此文件**不会**被加入延时复核队列。

#### 阶段二：延时复核

* 只有在**第一阶段完全成功**的文件，才会进入此阶段。
* 等待“复核延时”结束后，插件会再次通过**群文件系统API**检查该文件。
* 如果此时文件**依然有效**，机器人会**保持沉默**，不发送任何消息。
* 如果此时文件**已经失效**，机器人会**再次引用回复**原始消息，并发送“经xx秒后复核，已失效”的通知。

## 📝 版本记录

* **v1.1**
  * 新增 **即时内容预览** 功能，可在回复中显示文本文件开头内容。
  * 新增 **阶段一预检延时** 和 **文本预览长度** 的自定义配置项。
  * 优化 阶段一检查逻辑。
* **v1.0**
  * 插件首次发布。
  * 实现两阶段检查（即时检查 + 延时复核）核心功能。
  * 支持群聊白名单、成功通知开关、复核延时等基础配置。

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)
* 如果您在使用中遇到问题，欢迎在本仓库提交 [Issue](https://github.com/Foolllll-J/astrbot_plugin_file_checker/issues)。

